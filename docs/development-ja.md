# Harusame 開発ドキュメント

## 処理フロー詳細

### 1. 初期化処理 (`__construct`)
- デフォルト値の設定
  - `tcyDigit = 2` (縦中横の対象とする数字の桁数)
  - `autoTextOrientation = true` (文字の向き自動調整)
- オプションのバリデーション
  - `tcyDigit`
    - 整数値チェック（IllegalArgumentException）
    - 0以上の値チェック（IllegalArgumentException）
  - `autoTextOrientation`
    - 真偽値チェック（IllegalArgumentException）

### 2. テキスト変換のメインフロー (`transform`)
- DOMDocumentの初期化
  - UTF-8エンコーディングの設定
  - XMLの解析とエラーハンドリング
  - カスタムエラーハンドラの設定と復元
- フラグメントの作成と処理
  - `createDocumentFragment()`の使用
  - appendXMLでのエラーハンドリング（InvalidXMLException）
- テキストノードの抽出と処理
  - XPathを使用した`//body//text()`の取得
  - bodyタグが存在しない場合の`//text()`フォールバック
- 空のタグの処理
  - `notEmptyTags`配列で定義された要素の空ノードチェック
  - 必要に応じて空テキストノードの追加

### 3. 親ノードのチェック (`checkParentNode`)
- 除外条件の確認
  - `nodeType === 1`（ELEMENT_NODE）のチェック
  - タグ名による除外（code, pre, math, svg）
  - クラス名による除外（tcy, upright, sideways）
  - 再帰的な親ノードのチェック

### 4. フィルタリング処理 (`filter`)
- 除外パターンの正規表現
  - URL: 複雑なIPv4/IPv6アドレスを含むパターン
  - メールアドレス: `[0-9a-z_./?-]+@(?:[0-9a-z-]+\.)+[0-9a-z-]+`
  - HTML文字参照: `&#?[a-z0-9]{2,8};`
- テキストの分割と処理
  - `preg_split`による分割
  - 除外パターンのマッチング
  - 条件に応じた変換処理の適用

### 5. 縦中横処理 (`setTcy`)
- 感嘆符・疑問符の処理
  - パターン: `/(^|[^!?])([!?]{2})(?![!?])/u`
- 数字の処理
  - パターン: `/(^|[^0-9])([0-9]{2,N})(?![0-9])/u`
  - Nは`tcyDigit`の値に依存

### 6. 文字の向き処理 (`setTextOrientation`)
- 横転処理（sideways）
  - 数学記号（÷, ∴, ≠等）
  - 比較演算子（≦, ≧等）
  - その他の記号（∧, ∨等）
- 正立処理（upright）
  - ギリシャ文字
  - キリル文字
  - ローマ数字
  - その他の特殊文字

## エラーハンドリング

### XMLパース時のエラー処理
- カスタムエラーハンドラの設定
  - ErrorExceptionへの変換
  - try-catch-finallyでの適切な処理
- InvalidXMLExceptionの使用
  - 具体的なエラーメッセージの提供
  - 元のエラー情報の保持

### オプションのバリデーション
- IllegalArgumentExceptionの使用
  - 型チェック（int, bool）
  - 値の範囲チェック（tcyDigit >= 0）

## パフォーマンスに関する注意点

1. 正規表現の最適化
   - 非キャプチャグループ`(?:)`の使用
   - 適切なパターンマッチング
   - 大規模な正規表現パターンの分割

2. DOM操作の効率化
   - フラグメントの使用
   - 不要なノードの解放
   - XPathクエリの最適化

3. メモリ管理
   - 大きな文字列の分割処理
   - 一時変数の解放
   - フラグメントの適切な解放

## 今後の改善点

1. 正規表現パターンの最適化
   - 長大なパターンの分割
   - パフォーマンス改善

2. エラーメッセージの改善
   - より詳細なエラー情報の提供
   - 多言語対応

3. テストの拡充
   - エッジケースのカバー
   - パフォーマンステストの追加

4. ドキュメントの充実
   - APIリファレンスの整備
   - サンプルコードの追加 