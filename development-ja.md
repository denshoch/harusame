# Harusame 開発ドキュメント

## 処理フロー詳細

### 1. 初期化処理 (`__construct`)
- デフォルト値の設定
  - `tcyDigit = 2` (縦中横の対象とする数字の桁数)
  - `autoTextOrientation = true` (文字の向き自動調整)
- オプションのバリデーションと設定
  - 不正な値に対するエラー処理
  - 型チェック（int, bool）

### 2. テキスト変換のメインフロー (`transform`)
- DOMDocumentの初期化
  - UTF-8エンコーディングの設定
  - XMLの解析とエラーハンドリング
- テキストノードの抽出
  - XPathを使用して`//body//text()`を取得
  - bodyタグが存在しない場合は`//text()`を使用

### 3. 親ノードのチェック (`checkParentNode`)
- 除外対象の確認
  - タグ名による除外（code, pre, math, svg）
  - クラス名による除外（tcy, upright, sideways）
- 再帰的な親ノードの確認処理

### 4. フィルタリング処理 (`filter`)
- 除外パターンの検出
  - URL（複雑なパターンマッチング）
  - メールアドレス（`[0-9a-z_./?-]+@(?:[0-9a-z-]+\.)+[0-9a-z-]+`）
  - HTML文字参照（`&#?[a-z0-9]{2,8};`）
- テキストの分割と再結合
  - `preg_split`による分割
  - 条件に応じた変換処理の適用

### 5. 縦中横処理 (`setTcy`)
- 感嘆符・疑問符の処理
  - パターン: `/(^|[^!?])([!?]{2})(?![!?])/u`
  - `<span class="tcy">`でラップ
- 数字の処理
  - パターン: `/(^|[^0-9])([0-9]{2,N})(?![0-9])/u`
  - Nは`tcyDigit`の値

### 6. 文字の向き処理 (`setTextOrientation`)
- 横転処理
  - 対象: 数学記号（÷, ∴, ≠等）
  - `<span class="sideways">`でラップ
- 正立処理
  - 対象: ギリシャ文字、キリル文字、ローマ数字等
  - `<span class="upright">`でラップ

## エラーハンドリング

### XMLパース時のエラー処理
- 不正なXML文字列の検出
- エラーメッセージのログ出力
- 元のテキストを返却

### オプションのバリデーション
- `tcyDigit`
  - 整数値であることを確認
  - 0以上の値であることを確認
- `autoTextOrientation`
  - 真偽値であることを確認

## パフォーマンスに関する注意点

1. 正規表現の最適化
   - 非キャプチャグループ`(?:)`の使用
   - 適切なパターンマッチング

2. DOM操作の効率化
   - フラグメントの使用
   - 不要なノードの解放

3. メモリ管理
   - 大きな文字列の分割処理
   - 一時変数の解放

## 今後の改善点

1. 正規表現パターンの最適化
2. エラーメッセージの多言語対応
3. パフォーマンス改善のための処理の見直し
4. テストカバレッジの向上 