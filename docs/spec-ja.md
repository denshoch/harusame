# Harusame プログラム仕様書

## 概要
Harusameは、特定のHTML要素に対して特別なクラスを追加するライブラリです。このライブラリは、縦中横（Tate-Chu-Yoko）やテキストの向きを調整するために使用されます。

## 機能要件

### 処理対象
- **テキストノードのみを処理対象とする**:
  - HTMLのテキストノードのみを対象に変換処理を行い、タグノードはそのまま保持する。

### 処理対象の変換
- **特定の文字は特別なクラスでラップする**:
  - 数字のシーケンス（デフォルトは2桁）や感嘆符（疑問符）のシーケンスは、`<span class="tcy">`でラップする。
  - 特定の文字（例: 漢字や記号）は、`<span class="upright">`または`<span class="sideways">`でラップし、テキストの向きを調整する。

### 除外対象
- **特定のタグやクラス名を持つノードは除外する**:
  - 特定のタグ（例: `code`, `pre`, `math`, `svg`）や以下のクラス名を持つノードは、変換処理から除外する。
    - `tcy`: 縦中横の処理を行うためのクラス。
    - `upright`: 正立のテキストを示すためのクラス。
    - `sideways`: 横転のテキストを示すためのクラス。
  - 除外判定は再帰的に親ノードまで遡って行われる
  - 空のノードの場合は処理をスキップ

- **メールアドレスは変換処理から除外する**:
  - メールアドレスは、変換処理の対象外とし、元の形式を保持する。

- **URLは変換処理から除外する**:
  - URLも変換処理の対象外とし、元の形式を保持する。

- **文字参照は変換処理から除外する**:
  - HTML文字参照（例: `&#x3042;`）は、変換処理の対象外とし、元の形式を保持する。

- **不正なHTMLの処理**:
  - 不正なHTMLが入力された場合、元のテキストを返し、エラーメッセージを出力する。

### オプションによる設定
- **`tcyDigit`オプション**:
  - `.tcy`クラスを追加する数字の最大桁数を設定できる。0に設定すると、`.tcy`クラスは追加されない。

- **`autoTextOrientation`オプション**:
  - `.upright`および`.sideways`クラスを追加するかどうかを設定できる。

### 親ノードのチェック
- **特定のタグやクラス名を持つノードは除外する**:
  - 特定のタグ（例: `code`, `pre`, `math`, `svg`）や上記のクラス名を持つノードは、変換処理から除外する。

### フィルタリング処理
- **URL、メールアドレス、文字参照を検出し、除外する**:
  - URL: 複雑なIPv4/IPv6アドレスを含むURLパターン
  - メールアドレス: `[0-9a-z_./?-]+@(?:[0-9a-z-]+\.)+[0-9a-z-]+`
  - HTML文字参照: `&#?[a-z0-9]{2,8};`
  - 除外されたパターンは変換処理を行わず、そのまま出力される

## 主な機能
1. **テキスト変換**:
   - 数字のシーケンス（デフォルトは2桁）や感嘆符（疑問符）のシーケンスを`span.tcy`でラップします。
   - 各文字を`span.upright`または`span.sideways`でラップし、テキストの向きを調整します。
   - `tcyDigit`が0の場合、`.tcy`クラスは追加されません。

2. **HTMLの処理**:
   - HTML文字列を受け取り、ボディタグ内のテキストノードのみを変換します。
   - 不正なHTMLが入力された場合、元のテキストを返し、エラーメッセージをSTDERRに出力します。

## 使用方法
```php
$harusame = new Denshoch\Harusame();
$result = $harusame->transformText('テキスト例', ['tcyDigit' => 3]);
// => <span class="tcy">テキスト例</span>

// オプションを指定しない場合
$result = $harusame->transformText('テキスト例');
// => <span class="tcy">テキスト例</span>（デフォルトのtcyDigitが適用されます）
```

## オプション
- `tcyDigit`: integer（デフォルトは2） - `.tcy`クラスを追加する数字の最大桁数。0に設定すると、`.tcy`クラスは追加されません。
- `autoTextOrientation`: boolean（デフォルトはtrue） - `.upright`および`.sideways`クラスを追加するかどうか。

## エラーハンドリング

### XMLパース時のエラー処理
- **不正なXMLの処理**:
  - 不正なXMLが入力された場合、InvalidXMLExceptionがスローされる
  - エラーメッセージには具体的なエラー内容が含まれる
  - エラー発生時は元のテキストを返却

### オプションのバリデーション
- **tcyDigitオプション**:
  - 整数値でない場合、IllegalArgumentExceptionをスロー
  - 0未満の値の場合、IllegalArgumentExceptionをスロー
  - エラーメッセージ: "tcyDigit should be int." または "tcyDigit should be 0 or greater."

- **autoTextOrientationオプション**:
  - 真偽値でない場合、IllegalArgumentExceptionをスロー
  - エラーメッセージ: "autoTextOrientation should be boolean."

## テスト
- PHPUnitを使用してテストを実行します。テストは`tests`ディレクトリ内に配置されています。

# Harusame 処理フロー

`Harusame`クラスは、HTMLテキストを受け取り、特定のルールに基づいてテキストを変換するためのメソッドを提供します。以下に、主要なメソッドとその処理フローを示します。

## 1. `transform`メソッド
- **入力**: 変換対象のHTMLテキスト。
- **処理**:
  - HTMLをパースしてDOMノードを生成します。
  - 各ノードを処理するために`processNodes`メソッドを呼び出します。
- **出力**: 変換されたテキスト。

## 2. `processNodes`メソッド
- **入力**: パースされたDOMノードの配列。
- **処理**:
  - 各ノードをループ処理し、ノードのタイプに応じて処理を行います。
  - テキストノードの場合、`processText`メソッドを呼び出して変換を行います。
  - タグノードの場合、子ノードを再帰的に処理します。
- **出力**: 変換されたテキストを結合して返します。

## 3. `processText`メソッド
- **入力**: テキストノードの内容。
- **処理**:
  - `filter`メソッドを呼び出して、URLやメールアドレスなどの特定のパターンを除外します。
  - `setTcy`メソッドを呼び出して、指定された桁数の数字を`<span class="tcy">`でラップします。
  - `setTextOrientation`メソッドを呼び出して、特定の文字を`<span class="upright">`または`<span class="sideways">`でラップします。
- **出力**: 変換されたテキスト。

## 4. `setTcy`メソッド
- **入力**: テキスト。
- **処理**:
  - 正規表現を使用して、指定された桁数の数字を見つけ、`<span class="tcy">`でラップします。
- **出力**: 変換されたテキスト。

## 5. `setTextOrientation`メソッド
- **入力**: テキスト。
- **処理**:
  - 特定の文字を正規表現で見つけ、`<span class="upright">`または`<span class="sideways">`でラップします。
- **出力**: 変換されたテキスト。

## 6. `checkParentNode`メソッド
- **入力**: ノード。
- **処理**:
  - ノードの親が特定の条件を満たすかどうかを確認します（特定のタグ名やクラス名を持つかどうか）。
- **出力**: 条件を満たす場合は`true`、そうでない場合は`false`。

## 7. `filter`メソッド
- **入力**: テキスト。
- **処理**:
  - URL、メールアドレス、文字参照を正規表現で検出し、除外します。
  - 除外されていない部分に対して`setTcy`メソッドを適用します。
- **出力**: フィルタリングされたテキスト。

## 全体の流れ
1. `transform`メソッドが呼ばれ、HTMLテキストを受け取ります。
2. HTMLをパースし、ノードを生成します。
3. 各ノードを`processNodes`メソッドで処理します。
4. テキストノードは`processText`メソッドで変換され、タグノードは再帰的に処理されます。
5. 各テキストノードは、`filter`、`setTcy`、`setTextOrientation`メソッドを通じて変換されます。
6. 最終的に、変換されたテキストが返されます。

このように、`Harusame`クラスはHTMLテキストを受け取り、特定のルールに基づいてテキストを変換する一連のメソッドを通じて処理を行います。
